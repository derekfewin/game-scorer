<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Game Night Scorer</title>
    
    <!-- Styles -->
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- Error Logger -->
    <style>
        #debug-log { 
            display: none; 
            background: #fee; 
            border: 1px solid #c00; 
            color: #c00; 
            padding: 10px; 
            margin: 10px; 
            border-radius: 5px; 
            font-family: monospace; 
            font-size: 12px; 
            white-space: pre-wrap; 
        }
    </style>
    
    <!-- Error Handler -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            var d = document.getElementById('debug-log');
            if(d){
                d.style.display = 'block';
                d.innerHTML += "Error: " + msg + "\nLine: " + line + "\n\n";
            }
            return false;
        };
    </script>
</head>
<body>

<!-- Debug Log -->
<div id="debug-log"></div>

<!-- CUSTOM MODAL -->
<div id="custom-modal" class="modal-overlay">
    <div class="modal-box">
        <span id="modal-text" class="modal-text"></span>
        <div class="modal-btn-row">
            <button id="modal-cancel" class="modal-btn cancel" onclick="closeModal()">Cancel</button>
            <button id="modal-confirm" class="modal-btn confirm">Yes</button>
        </div>
    </div>
</div>

<!-- JOIN GAME MODAL -->
<div id="join-modal" class="modal-overlay" style="display:none">
    <div class="modal-box">
        <h3 style="margin-top:0">Join Game</h3>
        <input type="text" id="game-code-input" placeholder="Enter 6-digit code" 
               maxlength="6" style="text-align:center; font-size:24px; letter-spacing:5px; text-transform:uppercase;">
        <div class="modal-btn-row" style="margin-top:20px">
            <button class="modal-btn cancel" onclick="closeJoinModal()">Cancel</button>
            <button class="modal-btn confirm" onclick="attemptJoinGame()">Join</button>
        </div>
    </div>
</div>

<!-- SETUP SCREEN -->
<div class="card" id="setup-screen">
    <h2 style="text-align:center">ğŸ² Game Scorer</h2>
    <button id="restore-btn" class="btn-restore" style="display:none;" onclick="restoreGame()">âš ï¸ Resume Last Game</button>
    <button class="btn-info" onclick="showLeaderboard()">ğŸ† Leaderboard</button>

    <div class="setup-group">
        <label>Select Game</label>
        <select id="game-select" onchange="updateSetupUI()"></select>
    </div>
    
    <div class="setup-group">
        <label>Number of Players</label>
        <input type="hidden" id="player-count" value="4">
        <div class="player-count-grid">
            <button class="pc-btn" id="pc-2" onclick="setPlayerCount(2)">2</button>
            <button class="pc-btn" id="pc-3" onclick="setPlayerCount(3)">3</button>
            <button class="pc-btn active" id="pc-4" onclick="setPlayerCount(4)">4</button>
            <button class="pc-btn" id="pc-5" onclick="setPlayerCount(5)">5</button>
            <button class="pc-btn" id="pc-6" onclick="setPlayerCount(6)">6</button>
            <button class="pc-btn" id="pc-7" onclick="setPlayerCount(7)">7</button>
            <button class="pc-btn" id="pc-8" onclick="setPlayerCount(8)">8</button>
        </div>
    </div>
    
    <div id="target-option" class="setup-group" style="display:none;">
        <label>Target Score</label>
        <input type="number" id="target-score" inputmode="numeric">
    </div>
    
    <div id="team-option" class="setup-group" style="display:none;">
        <button id="use-teams" class="toggle-btn" onclick="toggleTeams()">Play in Teams?</button>
    </div>
    
    <div id="random-option" class="setup-group" style="display:none;">
        <button id="randomize-goals" class="toggle-btn" onclick="toggleRandomize()">ğŸ”€ Randomize Goals?</button>
    </div>
    
    <!-- ONLINE MULTIPLAYER OPTIONS -->
    <div class="setup-group" style="border-bottom:none; padding-bottom:0;">
        <button class="btn-game-action" onclick="showNamesAsHost()">ğŸ® Host Multiplayer Game</button>
        <button class="btn-outline" style="background:white; border-color:#2980b9; color:#2980b9;" onclick="showJoinPrompt()">ğŸ“± Join Multiplayer Game</button>
    </div>
    
    <button class="btn-game-action" onclick="showNames()">â–¶ Start Local Game</button>
</div>

<!-- NAME SCREEN -->
<div class="card" id="name-screen" style="display:none;">
    <h2 style="text-align:center">Who is Playing?</h2>
    
    <!-- Game Code Display (for hosts) -->
    <div id="game-code-display" style="display:none; text-align:center; margin-bottom:20px; 
         padding:15px; background:#e8f4fd; border-radius:10px; border:2px solid #3498db;">
        <div style="font-size:14px; color:#666; margin-bottom:5px">Share this code with viewers:</div>
        <div id="game-code-text" style="font-size:36px; font-weight:bold; 
             letter-spacing:8px; color:#2c3e50;"></div>
        <div style="font-size:12px; color:#666; margin-top:5px">
            <span id="viewer-count">0</span> viewer(s) connected
        </div>
    </div>
    
    <div id="name-inputs"></div>
    
    <!-- Host Self-Assignment Button -->
    <div id="host-claim-container" style="display:none; margin-top:15px;">
        <button class="btn-outline" style="background:#e8f4fd; border-color:#3498db; color:#2980b9;" 
                onclick="showHostIdentitySelection()">ğŸ® I'm Playing Too</button>
    </div>
    
    <button class="btn-game-action" onclick="startGame()">Start Game</button>
    <button class="btn-outline" onclick="cancelMultiplayer()">Back</button>
</div>

<!-- GAME SCREEN -->
<div class="card" id="game-screen" style="display:none;">
    <div class="game-header">
        <div class="round-title" id="round-label"></div>
        <div class="hero-display" id="hero-content"></div>
    </div>
    
    <div id="game-over-banner" style="display:none;">
        <h2>ğŸ† Game Over!</h2>
        <span class="winner-text" id="winner-display"></span>
    </div>
    
    <div id="input-area"></div>
    <div id="error-msg"></div>

    <button id="action-btn" class="btn-game-action" onclick="submitRound()">Submit</button>

    <div style="overflow-x:auto">
        <table id="score-table">
            <thead><tr id="table-head"></tr></thead>
            <tbody id="table-body"></tbody>
            <tfoot><tr id="table-foot" style="background:#eee; font-weight:bold"></tr></tfoot>
        </table>
    </div>
    
    <div id="controls-area">
        <button id="undo-btn" class="btn-undo" style="display:none" onclick="undoRound()">â†© Undo</button>
        
        <div id="exit-controls" style="display:flex; gap:10px; margin-top:20px;">
             <button id="abort-btn" class="btn-outline" style="margin-top:0;" onclick="abortGame()">âŒ Exit (No Save)</button>
             <button id="finish-btn" class="btn-game-action" style="margin-top:0; background-color:#27ae60;" onclick="finishGameNow()">ğŸ’¾ Finish & Save</button>
        </div>
    </div>
</div>

<!-- LEADERBOARD SCREEN -->
<div class="card" id="leaderboard-screen" style="display:none;">
    <h2 style="text-align:center">ğŸ† Hall of Fame</h2>
    <div id="lb-content"></div>
    
    <button class="btn-game-action" onclick="closeLeaderboard()">Main Menu</button>
    <button class="btn-outline" onclick="clearLeaderboard()">Reset All</button>

    <!-- BACKUP SECTION -->
    <div style="background:#e8f4fd; padding:15px; border-radius:10px; margin-top:20px; text-align:center; border:2px solid #3498db;">
        <h3 style="margin-top:0; color:#2c3e50;">â˜ï¸ Cloud Backup</h3>
        <p style="font-size:0.85em; color:#555;">Save your history to a file so you can move it to another device.</p>
        <button class="btn-game-action" style="background:#27ae60; margin-bottom:10px;" onclick="exportData()">â¬‡ï¸ Save to File</button>
        <button class="btn-outline" style="background:white; border-color:#2980b9; color:#2980b9;" onclick="triggerImport()">â¬†ï¸ Load from File</button>
        <input type="file" id="import-file" style="display:none" onchange="importData(this)">
    </div>
</div>

<!-- Load scripts in order -->
<script src="js/config.js"></script>
<script src="js/utils.js"></script>
<script src="js/state.js"></script>
<script src="js/storage.js"></script>

<!-- Game Classes -->
<script src="js/games/GameBase.js"></script>
<script src="js/games/Shanghai.js"></script>
<script src="js/games/MexicanTrain.js"></script>
<script src="js/games/OldHell.js"></script>
<script src="js/games/Spades.js"></script>
<script src="js/games/Hearts.js"></script>
<script src="js/games/Rummikub.js"></script>
<script src="js/games/Triominos.js"></script>
<script src="js/games/Qwirkle.js"></script>

<!-- UI Modules -->
<script src="js/ui/modals.js"></script>
<script src="js/ui/setup.js"></script>
<script src="js/ui/names.js"></script>
<script src="js/ui/table.js"></script>
<script src="js/ui/game.js"></script>
<script src="js/ui/leaderboard.js"></script>

<!-- Firebase Module (ES6 Module) -->
<script type="module" src="js/firebase.js"></script>

<!-- Initialize -->
<script>
    window.onload = function() {
        initApp();
        if('wakeLock' in navigator) {
            navigator.wakeLock.request('screen').catch(()=>{});
        }
    };
</script>

</body>
</html>